<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
  </head>
  <body>
    <div><input type="button" id="add" value="Add" /></div>
    <canvas width="500" height="500" style="border: 1px solid black;" id="main"></canvas>
    <script>
      function NiceSpacialRandom(width, height) {
        var created = [];
        var grid = [new Box(new P(0, 0), new P(width, height))];
        var freeGridSpots = [grid[0]];
        var splitHorizontal = true;

        this.width = width;
        this.height = height;
      
        this.next = function() {
          
          
 
          //console.log('freeGridSpots', freeGridSpots);
          //var gridSpot = rand(freeGridSpots, true);
          var gridSpot = freeGridSpots[0];
          freeGridSpots.splice(0, 1);
          
          //console.log('gridSpot', gridSpot, freeGridSpots);
          function pick() {
            for(var t=0; t<10; t++) {
              var p = new P(
                //gridSpot.tl.x + ((gridSpot.br.x - gridSpot.tl.x)/2.5), 
                rand(gridSpot.tl.x, gridSpot.br.x), 
                //gridSpot.tl.y + ((gridSpot.br.y - gridSpot.tl.y)/2.5)
                rand(gridSpot.tl.y, gridSpot.br.y)
              ); 
              gridSpot.p = p;
              return p;
            }
            throw 'Ran out of tries';
          }
          var picked = pick();
          
          if(freeGridSpots.length === 0) {
            grid.forEach(function(ebox){

              if(splitHorizontal) {
                var newY = ~~(ebox.tl.y + ((ebox.br.y-ebox.tl.y)/2));
                console.log('newY', newY);

                var newBox = new Box(new P(ebox.tl.x, newY), ebox.br.clone());
                console.log('newBox', newBox);
                ebox.br.y = newY;

                if(newBox.contains(ebox.p)){
                  newBox.p = ebox.p;
                  ebox.p = null;
                  freeGridSpots.push(ebox);
                } else {
                  freeGridSpots.push(newBox);
                }

                grid.push(newBox);
                
              } else {
                var newX = ~~(ebox.tl.x + ((ebox.br.x-ebox.tl.x)/2));
                console.log('newX', newX);

                var newBox = new Box(new P(newX, ebox.tl.y), ebox.br.clone());
                console.log('newBox', newBox);
                ebox.br.x = newX;

                if(newBox.contains(ebox.p)){
                  newBox.p = ebox.p;
                  ebox.p = null;
                  freeGridSpots.push(ebox);
                } else {
                  freeGridSpots.push(newBox);
                }

                grid.push(newBox);
              }
            });
            splitHorizontal = !splitHorizontal;
          }

          return picked;
        };

        this.render = function (ctx, scale, translate) {

         
          ctx.lineWidth = 0.5;

          grid.forEach(function(box){

            if(box.p){
               ctx.strokeStyle = '#FF0000';
             } else {
               ctx.strokeStyle = '#00FF00';
             }

            var tl = box.tl.add(translate.x).multi(scale);
            var br = box.br.add(translate.y).multi(scale);
            console.log('r', tl, br);
            ctx.strokeRect(tl.x+0.5, tl.y+0.5, (br.x-tl.x)-0.5, (br.y-tl.y)-0.5);
          }); 
        }
      }

      
      var canvas = document.getElementById('main');
      var context = canvas.getContext('2d');

      var lollies = [];
      var niceSpacialRandom = new NiceSpacialRandom(80, 80);
      var scaleF = 5;
     
      var ap = niceSpacialRandom.next().add(1).multi(scaleF);
      //var bp = niceSpacialRandom.next().add(1).multi(25);

      var a = new Lolly(ap, null);
      //var b = new Lolly(bp, null);
      
      lollies.push(a);
      //lollies.push(b);

      //var meetingPoint = new P(a.p.x, b.p.y);
      //a.lineP = meetingPoint;
      //b.lineP = meetingPoint;

      paint(context);

      document.getElementById('add').addEventListener('click', add);
      function add() {
        var p = niceSpacialRandom.next().add(1).multi(scaleF);
        lollies.push(new Lolly(p, null));
        paint(context);
      }

      function paint(ctx) {
        canvas.width = canvas.width;

        //niceSpacialRandom.render(ctx, scaleF, new P(1, 1));
        lollies.forEach(function(lolly){
          lolly.render(ctx);
        });
      }

      function Lolly(p, lineP) {
        var obj = {
          p: p,
          lineP: lineP,
          radius: 5,

          render: render
        }
        return obj;

        function render(ctx) {

          ctx.beginPath();
          ctx.arc(this.p.x, this.p.y, this.radius, 0, 2 * Math.PI, false);
          ctx.fillStyle = '#CEF2FC';
          ctx.fill();
          ctx.lineWidth = 3;
          ctx.strokeStyle = '#003300';
          ctx.stroke();

          if(this.lineP) {
            ctx.moveTo(this.p.x, this.p.y);
            ctx.lineTo(this.lineP.x, this.lineP.y);
            ctx.lineCap = 'round';
            ctx.stroke();
          }
        }

      }

      function Box(tl, br) {
        this.tl = tl;
        this.br = br;

        this.contains = function(p) {
          return p.x > tl.x && p.x < br.x
            && p.y > tl.y && p.y < br.y;
        }
      }

      function P(x, y) {
        this.x = x;
        this.y = y;
        this.clone = function() {
          return new P(this.x, this.y);
        }
        this.add = function(a) {
          return new P(this.x+a, this.y+a);
        };
        this.multi = function(a){
          return new P(this.x*a, this.y*a);
        };
      }


      function rand(a, b, c){
        //console.log('a, b', a, b, typeof(a), typeof(b));

        if(typeof(a) === 'object') {
          if(a instanceof Array ) {
            var index = ~~(Math.random() * a.length);
            var res = a[index];

            if(b) {
              a.splice(index, 1);
            }
            return res;
            
          }
        }

        if(typeof(a) === 'number') {
          if(typeof(b) === 'undefined' && typeof(c) === 'undefined') {
            return ~~(Math.random() * a);
          } else if(typeof(b) === 'number' && typeof(c) === 'undefined') {
            return a + ~~(Math.random() * (b-a));
          } else if(typeof(b) === 'number' && typeof(c) === 'number') {
            return ( ~~(a/c) + ~~(Math.random() * ((b-a)/c))) * c;
          }
        }
      }
    </script>
  </body>
</html>